
<!DOCTYPE html>
<html>
<head>
    <title>Cygnos music player</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
    <script type='text/javascript'>
        $(document)
            .ready(function () {
                $("#search")
                    .click(function () {
                        $.getJSON("api/search/" + $("#query").val(),
                            function (tracks) {
                                var items = [];
                                $.each(tracks,
                                    function (index, track) {
                                        items.push("<li data-trackData='" +
                                           JSON.stringify(track) +
                                            "'>" +
                                            track.trackName + ' [' + track.artistName + ']' +
                                            "</li>");
                                    });

                                $("#results").html(items.join(""));
                            });
                    });
                $("#stop").click(function () {
                    $.ajax({
                        type: "POST",
                        url: "api/player/stop"
                    });
                })
                $("#pause").click(function () {
                    $.ajax({
                        type: "POST",
                        url: "api/player/pause"
                    });
                })
                $("#results")
                    .on("click",
                        "li",
                        function () {
                            $.ajax({
                                type: "POST",
                                url: "api/player/play",
                                contentType: "application/json",
                                data: $(this).attr("data-trackData")
                            });
                        });
            });
    </script>
    <script src="http://js.leapmotion.com/leap-0.6.3.min.js"></script>
    <script src="js/timbre.js"></script>
    <script>

        var queue = [];

        function updateHandPlayer(handPlayer, step) {
            handPlayer.counter += step;
            if (handPlayer.counter >= handPlayer.instruments.length) {
                handPlayer.counter = 0;
            }
            handPlayer.currentInstrument = handPlayer.instruments[handPlayer.counter];
        }

        var controllerOptions = { enableGestures: true };

        var instruments1 = [T("sin"), T("pulse"), T("saw")/*, T("pink")*/];
        var instruments2 = [T("sin"), T("pulse"), T("saw")/*, T("pink")*/];
        var handPlayer1 = {id: -2, counter: 0, instruments: instruments1};
        var handPlayer2 = {id: -1, counter: 0, instruments: instruments2};

        var handPlayers = [handPlayer1, handPlayer2];

        // y should be within canvas height (400)
        function draw(y){
            var color = 'rgb(' + Math.floor((Math.random() * 255) + 1) + ',' + Math.floor((Math.random() * 255) + 1) + ',' + Math.floor((Math.random() * 255) + 1) + ')';
            var canvas = document.getElementById("canvas");
            var ctx = canvas.getContext("2d");
            ctx.fillStyle = color;
            // hardcoded x value
            var x = 700;
            //update x positions, remove if out of bounds of the canvas
            for (i = 0; i < queue.length - 1; i++) {
                if (queue[i].x === 0) queue.splice(i, 1);
                else queue[i].x--;
            }
            //add current position
            queue.push({x: x, y: y});
            // draw the queue of positions
            queue.forEach(function(pos, i){
                ctx.fillRect(pos.x, pos.y, 2, 2);
            });
        }

        Leap.loop(controllerOptions,
            function (frame) {
                frame.gestures.forEach(function(g, i) {
                    if (g.type === 'keyTap') {
                        g.handIds.forEach(function(id, i) {
                            var id = id;
                            handPlayers.forEach(function(handPlayer) {

                            if (handPlayer.id === id) {
                                console.log("keyTap", id);
                                handPlayer.instruments[handPlayer.counter].pause();
                                updateHandPlayer(handPlayer, 1);
                            }
                        });
                    });
                }
                });
                frame.hands.forEach(function(hand, i) {
                    var handPlayer = handPlayers[i];
                    handPlayer.id = hand.id;
                    var position = hand.palmPosition;
                    var instr = handPlayer.instruments[handPlayer.counter];
                    var y = position[1] * 3;
                    instr.set({freq: y});
                    draw(y/1500 * 500);
                    instr.play();
                });
                handPlayers.forEach(function(player, i) {
                    if (i >= frame.hands.length) {
                        player.instruments[player.counter].pause();
                    }
                });
            });
    </script>

</head>

<body>
    <canvas id="canvas" width="1200" height="500">
        Your browser does not support the canvas element.
    </canvas>
    <div class="container">
        <h1>Search for tracks</h1>
        <p>Type a search query and click on "Search". Then, click on any track to play it on server....</p>
        <input type="text" id="query" value="" class="form-control" placeholder="Search for..." />
        <button id="search" onclick="">Search</button>
        <button id="stop" onclick="">Stop</button>
        <button id="pause" onclick="">Pause</button>
        <div id="results"></div>
        <p id="gesture"></p>
    </div>
</body>

</html>
